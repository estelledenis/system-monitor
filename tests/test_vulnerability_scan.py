# tests/test_vulnerability_scan.py

import os
import json
from unittest.mock import patch, MagicMock

@patch('vulnerability_scan.nmap_scan.nmap.PortScanner')
def test_scan_localhost_creates_json(mock_portscanner_class):
    mock_scanner = MagicMock()
    mock_scanner.__getitem__.return_value = {"tcp": {22: {"state": "open"}}}
    mock_portscanner_class.return_value = mock_scanner

    from vulnerability_scan import nmap_scan

    output_path = nmap_scan.scan_localhost()

    assert os.path.exists(output_path)

    with open(output_path, "r", encoding="utf-8") as f:
        data = json.load(f)

    assert "scan_time" in data
    assert "host" in data
    assert "scan" in data

    os.remove(output_path)
