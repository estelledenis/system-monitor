import nmap
import json
import datetime
import sys
import tempfile
import os
import platform
import shutil

def check_nmap_installed():
    if not shutil.which("nmap"):
        raise EnvironmentError("Nmap is not installed or not in PATH. Please install Nmap.")

def scan_localhost():
    check_nmap_installed()
    nm = nmap.PortScanner()
    print("Scanning 127.0.0.1 for vulnerabilities...", flush=True)
    nm.scan('127.0.0.1', arguments='-sV --script vuln')

    report = {
        "scan_time": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        "host": "Your Computer (127.0.0.1)",
        "scan": nm["127.0.0.1"]
    }

    output_path = os.path.join(tempfile.gettempdir(), "nmap_scan_report.json")
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(report, f, indent=2)

    print(f"Scan complete. Report saved to {output_path}")
    return output_path

if __name__ == '__main__':
    if platform.system() not in ["Windows", "Darwin"]:
        raise EnvironmentError("Unsupported OS for this tool.")
    scan_localhost()
